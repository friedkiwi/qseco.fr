<!doctype html><html lang=en><head><title>Demystifying AS/400 DASD :: QSECO.FR</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="There seem to be quite a few misconceptions about AS/400 hard drives, commonly referred to as DASD (directly attached storage device). It is commonly known that only IBM-supplied DASD work, and typically only the FRUs listed. The big question though is “why is this the case?&amp;quot;.
Spinning disks die eventually. At the moment, generic SCSI disks are fairly commonly available, however, the FRUs to keep old AS/400 alive for hobbyist and archival purposes are becoming more and more scarce, with the supply eventually drying up."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=/research/demystifying-as400-dasd/><link rel=stylesheet href=/assets/style.css><link rel=stylesheet href=/assets/green.css><link rel=apple-touch-icon href=/img/apple-touch-icon-192x192.png><link rel="shortcut icon" href=/img/favicon/green.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Demystifying AS/400 DASD"><meta property="og:description" content="There seem to be quite a few misconceptions about AS/400 hard drives, commonly referred to as DASD (directly attached storage device). It is commonly known that only IBM-supplied DASD work, and typically only the FRUs listed. The big question though is “why is this the case?&amp;quot;.
Spinning disks die eventually. At the moment, generic SCSI disks are fairly commonly available, however, the FRUs to keep old AS/400 alive for hobbyist and archival purposes are becoming more and more scarce, with the supply eventually drying up."><meta property="og:url" content="/research/demystifying-as400-dasd/"><meta property="og:site_name" content="QSECO.FR"><meta property="og:image" content="/img/favicon/green.png"><meta property="og:image:width" content="2048"><meta property="og:image:height" content="1024"><meta property="article:published_time" content="2019-03-11 00:00:00 +0000 UTC"></head><body class=green><div class="container center headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>QSECO.FR</div></a></div><div class=menu-trigger>menu</div></div><nav class=menu><ul class="menu__inner menu__inner--desktop"><li><a href=/>Home</a></li><li><a href=/projects>Projects</a></li><li><a href=/blog>Blog</a></li><li><a href=/contact>Contact</a></li></ul><ul class="menu__inner menu__inner--mobile"><li><a href=/>Home</a></li><li><a href=/projects>Projects</a></li><li><a href=/blog>Blog</a></li><li><a href=/contact>Contact</a></li></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=/research/demystifying-as400-dasd/>Demystifying AS/400 DASD</a></h1><div class=post-meta><span class=post-date>2019-03-11</span></div><div class=post-content><div><p>There seem to be quite a few misconceptions about AS/400 hard drives, commonly referred to as DASD (directly attached storage device). It is commonly known that only IBM-supplied DASD work, and typically only the FRUs listed. The big question though is “why is this the case?".</p><p>Spinning disks die eventually. At the moment, generic SCSI disks are fairly commonly available, however, the FRUs to keep old AS/400 alive for hobbyist and archival purposes are becoming more and more scarce, with the supply eventually drying up.</p><h1 id=distinction-between-models>Distinction between models<a href=#distinction-between-models class=hanchor arialabel=Anchor>&#8983;</a></h1><p>Some of the information here is model-dependant, so a distinction is made between the following systems:</p><h1 id=ciscimpi-based-as400s>CISC/IMPI-based AS/400s<a href=#ciscimpi-based-as400s class=hanchor arialabel=Anchor>&#8983;</a></h1><p>These are the old pre-PowerPC-based AS/400s. They will typically run OS revisions up and until V3R2. They operate on a complex interaction of microcode on top of a more generic architecture and several subsystems, not unlike the channel architecture on it’s larger brethren. A more thorough description on how these machines work is a future project. Example model numbers are 9401-P03 or 9401-P02</p><h1 id=early-powerpc-based-as400>Early PowerPC-based AS/400<a href=#early-powerpc-based-as400 class=hanchor arialabel=Anchor>&#8983;</a></h1><p>PowerPC-based AS/400s were gradually introduced to replace the earlier CISC/IMPI-based models. Typically, the high end models were replaced first. PowerPC brought a massive speed boost to the AS/400 product line, however, it’s real potential was only realised later. Early OS revisions (e.g. V3R6) were direct ports of the CISC/IMPI-based code and were quite slow. A thorough rewrite of the kernel in V4 addressed most of these issues. Early PPC-based AS/400s would typically have been able to run V3R6 or later. Example models are e.g. the 9403-53X. I am still not convinced this is due to OS revision or hardware revision.</p><h1 id=powerpc-based-as400>PowerPC-based AS/400<a href=#powerpc-based-as400 class=hanchor arialabel=Anchor>&#8983;</a></h1><p>These are the models typically supplied with OS/400 V4 or later, all the way up until the Power5-based models (P5-based models are a special case though, but this is not relevant for DASD). Example models are 9406-170 or 9406-250</p><h1 id=520-522-and-512-bytes-per-sector>520, 522 and 512 bytes per sector<a href=#520-522-and-512-bytes-per-sector class=hanchor arialabel=Anchor>&#8983;</a></h1><p>It is currently commonly known that the AS/400 uses an odd sector size. However, the information that can be found online is quite contradictory - some sources quote 520, some 522. Some sources quote that 522 is only used in systems with a RAID controller. Based on my observations and tests this is not true - the difference does not lie in the use of a RAID controller or not, but in the type of AS/400. PowerPC-based AS/400s will typically have 522 bytes per sector, and CISC/IMPI-based AS/400s will have 520 bytes per sector. There are a few edge cases though, especially in early PowerPC-based AS/400s - if the DASD have been migrated from a CISC/IMPI-based machine they would not typically be re-formatted on those early machines on the OS/revisions at the time.</p><h1 id=so-tldr>So, TL;DR:<a href=#so-tldr class=hanchor arialabel=Anchor>&#8983;</a></h1><ul><li>Standard SCSI disks: 512 bytes per sector</li><li>CISC/IMPI-based AS/400: 520 bytes per sector</li><li>Early PowerPC-based AS/400: 520 or 522 bytes per sector</li><li>PowerPC-based AS/400s: 522 bytes per sector.</li></ul><h1 id=custom-vpd>Custom VPD<a href=#custom-vpd class=hanchor arialabel=Anchor>&#8983;</a></h1><p>This would be obvious to anyone with any idea on how SCSI disks work, but the vital product data on AS/400 DASD contains entries verified by the firmware. This VPD typically contains serial number, disk type (e.g. 6713) and serial number. When installing SLIC on a PowerPC-based AS/400, this is verified to contain the expected data. Another quirk to note is that the OS does not (always) rely on SCSI READ CAPACITY commands to identify the size of the DASD. As a result, putting the VPD of a 6714 (~18GB) over a 70GB volume does not result in the drive being detected as a 70GB drive.</p><h1 id=magic-commands>Magic commands<a href=#magic-commands class=hanchor arialabel=Anchor>&#8983;</a></h1><p>Another common misconceptions is that IBM uses proprietary commands to interact with the drive. This is actually not entirely true. There are however a few implementation based quirks that the OS relies on when dealing with drives.</p><h1 id=scsi-format-implementation>SCSI FORMAT implementation<a href=#scsi-format-implementation class=hanchor arialabel=Anchor>&#8983;</a></h1><p>The SCSI FORMAT implementation needs to be accurate. The OS relies on the disks being formatted using a SCSI FORMAT command. OS/400 technically doesn’t have a file system (more about that will be documented in another write-up), and the way it deals with data storage requires hard drives to be completely empty upon first use. If the SCSI FORMAT implementation doesn’t fill the drive with the specified pattern (not all drives implement this properly), the OS installer will crash/hang because it tries to read a few sectors to verify if formatting succeeded (it does not just trust the status code returned by the SCSI FORMAT command).</p><h1 id=skip-readskip-write>SKIP READ/SKIP WRITE<a href=#skip-readskip-write class=hanchor arialabel=Anchor>&#8983;</a></h1><p>To optimise disk read and writes, OS/400 heavily relies on SKIP READ and SKIP WRITE. These commands need to be implemented and need to be implemented properly. More information about this can be found on <a href=http://ps-2.kev009.com/rs6000/manuals/SAN/ESS/2105_Model_ExxFxx/ESS_SCSI_Command_Reference_ExxFxx_SC26-7297-01.PDF>http://ps-2.kev009.com/rs6000/manuals/SAN/ESS/2105_Model_ExxFxx/ESS_SCSI_Command_Reference_ExxFxx_SC26-7297-01.PDF</a>. The reason why OS/400 relies on this is another story, closely related to the way the file system (or lack thereof) works.</p><h1 id=conclusion>Conclusion<a href=#conclusion class=hanchor arialabel=Anchor>&#8983;</a></h1><p>That’s it really. The only things which makes an AS/400 DASD special are:</p><ul><li>Custom VPD</li><li>520/522 byte sector size based on model</li><li>SCSI FORMAT being implemented properly</li><li>SKIP READ and SKIP WRITE being implemented properly</li></ul><p>I hope this helps some people troubleshooting their failing hard drives.</p></div></div></div></div><footer class=footer><div class=footer__inner><div class="copyright copyright--user"><span>QSECO.FR Consulting</span></div></div></footer><script src=/assets/main.js></script><script src=/assets/prism.js></script><script type=text/javascript>var _paq=window._paq=window._paq||[];_paq.push(["setDocumentTitle",document.domain+"/"+document.title]),_paq.push(["setCookieDomain","*.qseco.fr"]),_paq.push(['trackPageView']),_paq.push(['enableLinkTracking']),function(){var b="https://stasi.cyber.gent/",c,a,d;_paq.push(['setTrackerUrl',b+'matomo.php']),_paq.push(['setSiteId','3']),c=document,a=c.createElement('script'),d=c.getElementsByTagName('script')[0],a.type='text/javascript',a.async=!0,a.src=b+'matomo.js',d.parentNode.insertBefore(a,d)}()</script><noscript><p><img src="https://stasi.cyber.gent/matomo.php?idsite=3&rec=1" style=border:0 alt></p></noscript></div></body></html>